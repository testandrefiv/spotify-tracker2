<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Stream Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 12px; }
        .status-new { background-color: #d1e7dd; color: #0f5132; }
        .status-reset { background-color: #f8d7da; color: #842029; }
        .status-ok { background-color: #cfe2ff; color: #084298; }
        .status-updating { background-color: #fff3cd; color: #664d03; animation: pulse 1.5s infinite; }
        .navbar-brand { font-weight: bold; color: #1db954 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .rename-btn { cursor: pointer; color: #6c757d; margin-left: 10px; font-size: 0.9rem; }
        .rename-btn:hover { color: #000; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fab fa-spotify"></i> Stream Tracker</a>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card p-3 text-center">
                    <h3><i class="fas fa-list"></i> <span id="total-playlists">0</span></h3>
                    <small>Total Playlists</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center">
                    <h3><i class="fas fa-music"></i> <span id="total-tracks">0</span></h3>
                    <small>Total Tracks</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center">
                    <h3><i class="fas fa-chart-line"></i> <span id="total-streams">0</span></h3>
                    <small>Total Streams</small>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <input type="text" id="playlist-url" class="form-control d-inline-block w-auto" placeholder="Spotify Playlist URL">
                    <button class="btn btn-success" onclick="addPlaylist()">Add Playlist</button>
                </div>
                <button class="btn btn-primary" onclick="forceUpdate()">
                    <i class="fas fa-sync"></i> Force Update
                </button>
            </div>
        </div>

        <div id="playlists-container">
            </div>
        
        <div class="card p-3">
            <h5>System Logs</h5>
            <div id="logs-box" style="height: 200px; overflow-y: scroll; background: #eee; padding: 10px; font-family: monospace; font-size: 0.9em;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "/api";
        let token = localStorage.getItem("token");

        if (!token) window.location.href = "/";

        async function fetchWithAuth(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers["Authorization"] = "Bearer " + token;
            const response = await fetch(url, options);
            if (response.status === 401) {
                logout();
            }
            return response;
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "/";
        }

        async function loadSummary() {
            const res = await fetchWithAuth(API_URL + "/summary");
            const data = await res.json();
            document.getElementById("total-playlists").innerText = data.total_playlists;
            document.getElementById("total-tracks").innerText = data.total_tracks;
            document.getElementById("total-streams").innerText = data.total_streams.toLocaleString();
        }

        async function loadPlaylistsData() {
            const res = await fetchWithAuth(API_URL + "/full_data");
            const data = await res.json();
            const container = document.getElementById("playlists-container");
            container.innerHTML = "";

            data.forEach(p => {
                let statusBadge = "";
                if (p.status === "Updating...") {
                    statusBadge = `<span class="badge status-updating"><i class="fas fa-spinner fa-spin"></i> Updating...</span>`;
                } else if (p.status === "Updated") {
                    statusBadge = `<span class="badge status-ok"><i class="fas fa-check"></i> Updated</span>`;
                } else if (p.status === "Failed") {
                    statusBadge = `<span class="badge status-reset"><i class="fas fa-times"></i> Failed</span>`;
                } else {
                    statusBadge = `<span class="badge bg-secondary">Idle</span>`;
                }

                let rows = "";
                p.tracks.forEach((t, i) => {
                    // Logic for showing "-" if data is null or 0 (insufficient history)
                    const weeklyVal = (t.weekly && t.weekly > 0) ? `+${t.weekly.toLocaleString()}` : "-";
                    const monthlyVal = (t.monthly && t.monthly > 0) ? `+${t.monthly.toLocaleString()}` : "-";

                    rows += `
                        <tr>
                            <td>${i + 1}</td>
                            <td><a href="${t.url}" target="_blank" style="text-decoration:none; color:black;">${t.name}</a></td>
                            <td>${t.artist}</td>
                            <td>${t.total.toLocaleString()}</td>
                            <td class="text-success">+${t.daily.toLocaleString()}</td>
                            <td class="text-primary">${weeklyVal}</td>
                            <td class="text-info">${monthlyVal}</td>
                            <td><span class="status-badge status-${t.status.toLowerCase()}">${t.status}</span></td>
                        </tr>
                    `;
                });

                const html = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                ${p.playlist_name} 
                                <i class="fas fa-pencil-alt rename-btn" onclick="renamePlaylist(${p.playlist_id}, '${p.playlist_name}')" title="Rename for Dashboard"></i>
                            </h5>
                            <div>
                                ${statusBadge}
                                <span class="badge bg-dark ms-2">${p.track_count} Tracks</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>#</th><th>Track</th><th>Artist</th><th>Total</th><th>Daily</th><th>Weekly</th><th>Monthly</th><th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function addPlaylist() {
            const url = document.getElementById("playlist-url").value;
            if (!url) return alert("Enter a URL");
            
            const res = await fetchWithAuth(API_URL + "/playlists", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: url })
            });

            if (res.ok) {
                alert("Playlist added! It will start updating shortly.");
                document.getElementById("playlist-url").value = "";
                loadSummary();
                loadPlaylistsData();
            } else {
                alert("Error adding playlist");
            }
        }

        async function forceUpdate() {
            const res = await fetchWithAuth(API_URL + "/force_update", { method: "POST" });
            if (res.ok) {
                alert("Update started! Watch the logs.");
                loadLogs();
            }
        }

        async function renamePlaylist(id, currentName) {
            const newName = prompt("Enter new name for dashboard display:", currentName);
            if (newName && newName !== currentName) {
                const res = await fetchWithAuth(API_URL + `/playlists/${id}/rename`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ custom_name: newName })
                });
                if (res.ok) {
                    loadPlaylistsData(); // Refresh to see name
                } else {
                    alert("Failed to rename");
                }
            }
        }

        async function loadLogs() {
            const res = await fetchWithAuth(API_URL + "/logs");
            const logs = await res.json();
            const box = document.getElementById("logs-box");
            box.innerHTML = logs.map(l => `<div>[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}</div>`).join("");
        }

        // Auto-refresh logic
        setInterval(loadLogs, 5000);
        setInterval(loadPlaylistsData, 10000); // Check for status updates every 10s

        loadSummary();
        loadPlaylistsData();
        loadLogs();
    </script>
</body>
</html>
